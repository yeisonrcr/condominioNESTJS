
// ROSEDAL II - SCHEMA DE BASE DE DATOS
// 17 Tablas Optimizadas con Seguridad


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// 1. USUARIOS DEL SISTEMA

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  passwordHash     String    @map("password_hash")
  role             UserRole
  houseId          Int?      @map("house_id")
  firstName        String    @map("first_name") @db.VarChar(100)
  lastName         String    @map("last_name") @db.VarChar(100)
  phone            String?   @db.VarChar(20)
  
  // Seguridad
  isActive         Boolean   @default(true) @map("is_active")
  isLocked         Boolean   @default(false) @map("is_locked")
  failedAttempts   Int       @default(0) @map("failed_attempts")
  lockedUntil      DateTime? @map("locked_until")
  twoFactorSecret  String?   @map("two_factor_secret")
  twoFactorEnabled Boolean   @default(false) @map("two_factor_enabled")
  
  lastLogin        DateTime? @map("last_login")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  
  // Relaciones
  house            House?    @relation(fields: [houseId], references: [id])
  sessions         Session[]
  auditLogs        AuditLog[]
  
  @@index([email])
  @@index([role, isActive])
  @@index([houseId])
  @@map("users")
}

enum UserRole {
  admin    // Administrador completo
  filial   // Junta directiva
  oficial  // Oficial de seguridad
  
  @@map("user_role")
}


// 2. SESIONES (para refresh tokens)

model Session {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  tokenHash    String    @unique @map("token_hash")
  isRevoked    Boolean   @default(false) @map("is_revoked")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.Text
  expiresAt    DateTime  @map("expires_at")
  lastActivity DateTime  @default(now()) @map("last_activity")
  createdAt    DateTime  @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}


// 3. CASAS (56 casas del condominio)

model House {
  id          Int         @id @default(autoincrement())
  houseNumber Int         @unique @map("house_number")
  status      HouseStatus @default(active)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relaciones
  users       User[]
  persons     Person[]
  vehicles    Vehicle[]
  pets        Pet[]
  visits      Visit[]
  
  @@index([status])
  @@map("houses")
}

enum HouseStatus {
  active
  obsolete
  
  @@map("house_status")
}


// 4. PERSONAS AUTORIZADAS POR CASA

model Person {
  id         Int        @id @default(autoincrement())
  houseId    Int        @map("house_id")
  type       PersonType
  firstName  String     @map("first_name") @db.VarChar(100)
  lastName   String     @map("last_name") @db.VarChar(100)
  cedula     String?    @db.VarChar(20)
  phone      String?    @db.VarChar(20)
  isActive   Boolean    @default(true) @map("is_active")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@index([houseId])
  @@index([cedula])
  @@map("persons")
}

enum PersonType {
  owner             // Propietario
  resident          // Residente
  authorized        // Autorizado permanente
  domestic_service  // Servicio doméstico
  emergency_contact // Contacto emergencia
  
  @@map("person_type")
}


// 5. VEHÍCULOS

model Vehicle {
  id          Int      @id @default(autoincrement())
  houseId     Int      @map("house_id")
  type        VehicleType
  brand       String   @db.VarChar(50)
  model       String   @db.VarChar(50)
  color       String   @db.VarChar(30)
  licensePlate String  @unique @map("license_plate") @db.VarChar(20)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@index([houseId])
  @@index([licensePlate])
  @@map("vehicles")
}

enum VehicleType {
  car
  motorcycle
  truck
  suv
  
  @@map("vehicle_type")
}


// 6. MASCOTAS

model Pet {
  id        Int      @id @default(autoincrement())
  houseId   Int      @map("house_id")
  name      String   @db.VarChar(50)
  species   String   @db.VarChar(30)
  breed     String?  @db.VarChar(50)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@index([houseId])
  @@map("pets")
}


// 7. VISITAS

model Visit {
  id              Int         @id @default(autoincrement())
  houseId         Int         @map("house_id")
  visitorName     String      @map("visitor_name") @db.VarChar(100)
  visitorCedula   String?     @map("visitor_cedula") @db.VarChar(20)
  visitorPhone    String?     @map("visitor_phone") @db.VarChar(20)
  vehiclePlate    String?     @map("vehicle_plate") @db.VarChar(20)
  
  // Control de entrada/salida
  entryTime       DateTime    @default(now()) @map("entry_time")
  exitTime        DateTime?   @map("exit_time")
  entryOficialId  String      @map("entry_oficial_id")
  exitOficialId   String?     @map("exit_oficial_id")
  
  // Firma digital cifrada
  entrySignature  String?     @map("entry_signature") @db.Text
  exitSignature   String?     @map("exit_signature") @db.Text
  
  observations    String?     @db.Text
  status          VisitStatus @default(active)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@index([houseId])
  @@index([status])
  @@index([entryTime])
  @@map("visits")
}

enum VisitStatus {
  active    // Visitante dentro
  completed // Visita finalizada
  cancelled // Cancelada
  
  @@map("visit_status")
}


// 8. LOGS DE AUDITORÍA (cifrado)

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String   @db.VarChar(100)
  entity    String   @db.VarChar(50)
  entityId  String?  @map("entity_id")
  details   String?  @db.Text // Datos sensibles cifrados
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}


// 9. CHAT (WebSocket messages)

model ChatMessage {
  id        String      @id @default(uuid())
  senderId  String      @map("sender_id")
  room      String      // "admin", "house:1", "security"
  message   String      @db.Text
  type      MessageType @default(text)
  isRead    Boolean     @default(false) @map("is_read")
  createdAt DateTime    @default(now()) @map("created_at")
  
  @@index([room])
  @@index([createdAt])
  @@map("chat_messages")
}

enum MessageType {
  text
  image
  file
  system
  
  @@map("message_type")
}


// FIN DEL SCHEMA
